<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mom's Self-Care Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f8fb; /* Light blue background */
        }
        /* Style for active nav tab */
        .nav-tab.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
        /* Simple transition for page visibility */
        .page-content {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 md:p-8 mt-8">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800">Self-Care Tracker</h1>
            <p class="text-gray-500 mt-2">Time for you. Log your essential activities.</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex border-b border-gray-200 mb-6">
            <button id="nav-tracker" onclick="showPage('tracker')" class="nav-tab flex-1 py-3 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-500 transition">
                Tracker
            </button>
            <button id="nav-progress" onclick="showPage('progress')" class="nav-tab flex-1 py-3 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-500 transition">
                Progress
            </button>
        </nav>

        <!-- Page Content: Tracker -->
        <main id="tracker-page" class="page-content">
            <!-- Action Buttons -->
            <section id="action-buttons" class="grid grid-cols-3 gap-4 mb-10">
                <!-- Eat Button -->
                <button onclick="recordActivity('EAT')"
                    class="flex flex-col items-center justify-center p-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                    <span class="text-3xl mb-1">üçé</span>
                    <span class="text-sm md:text-base">Eat</span>
                </button>
                <!-- Sleep Button -->
                <button onclick="recordActivity('SLEEP')"
                    class="flex flex-col items-center justify-center p-4 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-xl transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                    <span class="text-3xl mb-1">üõå</span>
                    <span class="text-sm md:text-base">Sleep</span>
                </button>
                <!-- Shower Button -->
                <button onclick="recordActivity('SHOWER')"
                    class="flex flex-col items-center justify-center p-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-xl transition transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                    <span class="text-3xl mb-1">üöø</span>
                    <span class="text-sm md:text-base">Shower</span>
                </button>
            </section>

            <!-- History Display -->
            <section>
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">Recent History</h2>
                <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <!-- History items will be inserted here -->
                    <p id="history-loading" class="text-center text-gray-400">Loading history...</p>
                </div>
                <button onclick="showClearHistoryModal()" class="mt-6 w-full text-center text-sm text-red-500 hover:text-red-700 transition">
                    Clear All History
                </button>
            </section>
        </main>

        <!-- Page Content: Progress (Hidden by default) -->
        <main id="progress-page" class="page-content hidden">
            <!-- Summary Cards -->
            <section>
                <h2 class="text-xl font-bold text-gray-700 mb-4">Summary: Last 24 Hours</h2>
                <div id="summary-cards" class="grid grid-cols-3 gap-4 mb-8">
                    <!-- Cards will be injected by JS -->
                    <p id="summary-loading" class="text-center text-gray-400 col-span-3">Loading summary...</p>
                </div>
            </section>
            
            <!-- Chart -->
            <section>
                <h2 class="text-xl font-bold text-gray-700 mb-4">Activity: Last 7 Days</h2>
                <div id="chart-container" class="w-full h-64 bg-gray-50 rounded-lg p-2">
                    <!-- D3 Chart will be injected here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Confirmation Modal (Hidden by default) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium text-gray-900">Are you sure?</h3>
            <p class="mt-2 text-sm text-gray-500">
                This will permanently delete all logged activities. This action cannot be undone.
            </p>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="cancelClear()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button onclick="clearHistoryConfirmed()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    Delete
                </button>
            </div>
        </div>
    </div>
    <!-- End Modal -->

    <script>
        // --- API Configuration ---
        const API_BASE_URL = 'http://localhost:8080/selfcare';

        // --- Page Navigation ---
        const pages = ['tracker-page', 'progress-page'];
        const navTabs = {
            'tracker': document.getElementById('nav-tracker'),
            'progress': document.getElementById('nav-progress')
        };

        function showPage(pageId) {
            pages.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            Object.values(navTabs).forEach(tab => tab.classList.remove('active'));

            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            navTabs[pageId].classList.add('active');

            // Load data for the shown page
            if (pageId === 'tracker') {
                loadHistory();
            } else if (pageId === 'progress') {
                loadSummary();
            }
        }

        // --- Helper Functions ---
        function getActivityColor(type) {
            switch (type) {
                case 'EAT': return 'bg-green-100 text-green-800 border-green-300';
                case 'SLEEP': return 'bg-indigo-100 text-indigo-800 border-indigo-300';
                case 'SHOWER': return 'bg-sky-100 text-sky-800 border-sky-300';
                default: return 'bg-gray-100 text-gray-700 border-gray-300';
            }
        }

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
        }

        // --- Tracker Page: History ---
        function renderHistory(activities) {
            const list = document.getElementById('history-list');
            list.innerHTML = ''; // Clear loading/stale data

            if (activities.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 p-4 rounded-lg bg-gray-50">No activities logged yet. Get started!</p>';
                return;
            }

            // Note: Service layer now handles sorting
            // activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            activities.forEach(activity => {
                const item = document.createElement('div');
                const colorClass = getActivityColor(activity.type);

                item.className = `flex justify-between items-center p-3 border rounded-lg ${colorClass}`;
                item.innerHTML = `
                    <span class="font-medium capitalize text-lg">${activity.type.toLowerCase()}</span>
                    <span class="text-sm">${formatTimestamp(activity.timestamp)}</span>
                `;
                list.appendChild(item);
            });
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            const loading = document.getElementById('history-loading');
            if (loading) loading.style.display = 'block';
            try {
                const response = await fetch(`${API_BASE_URL}/history`);
                if (!response.ok) throw new Error('Network response was not ok');
                const history = await response.json();
                renderHistory(history);
            } catch (error) {
                console.error('Failed to load history:', error);
                list.innerHTML = '<p class="text-center text-red-500">Failed to load history.</p>';
            }
        }

        async function recordActivity(activityType) {
            const newActivity = {
                type: activityType,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE_URL}/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newActivity)
                });

                if (!response.ok) throw new Error('Failed to save activity');
                
                // Reload history to show the new item
                loadHistory();

            } catch (error) {
                console.error('Network Error:', error);
                // You could show an error message to the user here
            }
        }

        // --- Tracker Page: Clear History Modal ---
        const modal = document.getElementById('confirm-modal');
        function showClearHistoryModal() {
            modal.classList.remove('hidden');
        }
        function cancelClear() {
            modal.classList.add('hidden');
        }
        async function clearHistoryConfirmed() {
            try {
                 const response = await fetch(`${API_BASE_URL}/history/clear`, {
                    method: 'DELETE'
                 });
                 if (!response.ok) throw new Error('Failed to clear history');
                 
                 loadHistory(); // Refresh the list (will be empty)
                 cancelClear(); // Close the modal
            } catch (error) {
                 console.error('Failed to clear history:', error);
                 // We don't use alert()
                 console.error('Error: Could not clear history.');
            }
        }

        // --- Progress Page: Summary & Chart ---
        async function loadSummary() {
            const cardContainer = document.getElementById('summary-cards');
            const chartContainer = document.getElementById('chart-container');
            cardContainer.innerHTML = '<p id="summary-loading" class="text-center text-gray-400 col-span-3">Loading summary...</p>';
            chartContainer.innerHTML = ''; // Clear old chart

            try {
                const response = await fetch(`${API_BASE_URL}/summary`);
                if (!response.ok) throw new Error('Network response was not ok');
                const summary = await response.json();
                
                renderSummaryCards(summary.last24Hours);
                renderChart(summary.last7Days);

            } catch (error) {
                console.error('Failed to load summary:', error);
                cardContainer.innerHTML = '<p class="text-center text-red-500 col-span-3">Failed to load summary.</p>';
            }
        }

        function renderSummaryCards(data24h) {
            const container = document.getElementById('summary-cards');
            container.innerHTML = ''; // Clear loading

            const icons = { EAT: 'üçé', SLEEP: 'üõå', SHOWER: 'üöø' };
            const colors = {
                EAT: 'text-green-600',
                SLEEP: 'text-indigo-600',
                SHOWER: 'text-sky-600'
            };

            ['EAT', 'SLEEP', 'SHOWER'].forEach(type => {
                const count = data24h[type] || 0;
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-50 rounded-lg text-center shadow-sm';
                card.innerHTML = `
                    <span class="text-4xl">${icons[type]}</span>
                    <p class="text-3xl font-bold ${colors[type]}">${count}</p>
                    <p class="text-sm text-gray-500 font-medium">${type}</p>
                `;
                container.appendChild(card);
            });
        }

        function renderChart(data7d) {
            const chartData = [
                { type: 'Eat', count: data7d.EAT || 0, color: '#10b981' }, // green-600
                { type: 'Sleep', count: data7d.SLEEP || 0, color: '#6366f1' }, // indigo-500
                { type: 'Shower', count: data7d.SHOWER || 0, color: '#0ea5e9' } // sky-500
            ];

            const container = document.getElementById('chart-container');
            container.innerHTML = ''; // Clear previous chart

            // D3 Chart Setup
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${container.clientWidth} ${container.clientHeight}`)
                .append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            // X scale (band for names)
            const xScale = d3.scaleBand()
                .domain(chartData.map(d => d.type))
                .range([0, width])
                .padding(0.4);

            // Y scale (linear for count)
            const yScale = d3.scaleLinear()
                .domain([0, Math.max(10, d3.max(chartData, d => d.count))]) // Min height of 10
                .range([height, 0]);

            // X Axis
            svg.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('font-size', '12px')
                .style('font-family', 'Inter');

            // Y Axis
            svg.append('g')
                .call(d3.axisLeft(yScale).ticks(5))
                .selectAll('text')
                .style('font-size', '12px')
                .style('font-family', 'Inter');

            // Bars
            svg.selectAll('.bar')
                .data(chartData)
                .enter()
                .append('rect')
                .attr('x', d => xScale(d.type))
                .attr('y', d => yScale(0)) // Start at 0 for animation
                .attr('width', xScale.bandwidth())
                .attr('height', 0) // Start at 0 for animation
                .attr('fill', d => d.color)
                .attr('rx', 4) // Rounded corners
                .transition()
                .duration(750)
                .attr('y', d => yScale(d.count))
                .attr('height', d => height - yScale(d.count));
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('tracker'); // Show tracker page by default
        });
    </script>
</body>
</html>

